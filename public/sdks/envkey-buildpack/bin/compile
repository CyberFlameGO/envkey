#!/usr/bin/env bash
set -eo pipefail

indent() {
  sed -u 's/^/       /'
}

echo "-----> Attempting to load, decrypt, and export EnvKey variables"

BP_DIR=$(cd $(dirname ${0:-}); cd ..; pwd)
BUILD_DIR=${1:-}
ENV_DIR=${3:-}

if [ -f $ENV_DIR/ENVKEY ]; then
  curl -s -o .ek_tmp_version https://envkey-releases.s3.amazonaws.com/latest/envkeysource-version.txt
  ENVKEY_VERSION=$(cat .ek_tmp_version)
  rm .ek_tmp_version

  ENVKEY_URL="https://envkey-releases.s3.amazonaws.com/envkeysource/release_artifacts/${ENVKEY_VERSION}/envkey-source_${ENVKEY_VERSION_linux_amd64}.tar.gz"
  echo "Downloading envkey-source ${ENVKEY_VERSION}..." | indent
  curl -s -L -o envkey-source.tar.gz "${ENVKEY_URL}"
  tar zxf envkey-source.tar.gz envkey-source

  mkdir -p $BUILD_DIR/envkey
  mv envkey-source $BUILD_DIR/envkey/

  echo "ENVKEY is set" | indent
  export "ENVKEY=$(cat $ENV_DIR/ENVKEY)"
  echo $(./envkey-source) > $BP_DIR/export
  echo "EnvKey variables exported to subsequent buildpacks" | indent
  mkdir $BUILD_DIR/.profile.d
  cat > $BUILD_DIR/.profile.d/envkey.sh << EOF
export -p > ./envkey-runtime-env.sh
$(cat $BP_DIR/export)
. ./envkey-runtime-env.sh
rm envkey-runtime-env.sh
export PATH=$PATH:$HOME/$BUILD_DIR/envkey
EOF
  echo "EnvKey variables exported to running application via .profile.d/envkey.sh" | indent
  echo "envkey-source executable is available for use" | indent
else
  echo "ENVKEY not set" | indent
  exit 1
fi
